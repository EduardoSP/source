{% extends baseTemplate %}
<!-- {#% extends "webfleetbigui/baseAdminTenant.html" %#} -->
{% load staticfiles %}
{% block titulo %}Rutas{% endblock %}

{% block codigoPrincipal %}

<!-- Estilos -->
<link href="{% static "select/css/bootstrap-select.min.css" %}"           rel="stylesheet">
<link href="{% static "select/css/bootstrap-select.min.css" %}"           rel="stylesheet">
<link href="{% static "css/base.css" %}"  rel="stylesheet">
<link href="{% static "DataTables/datatables.min.css" %}" rel="stylesheet" type="text/css"  />
<link href="{% static "datetimepicker/css/bootstrap-datetimepicker.min.css" %}"           rel="stylesheet">
<link href="{% static "mapsPicker/jquery-gmaps-latlon-picker.css" %}" rel="stylesheet" type="text/css" />

<!-- Bibliotecas -->
<script src="{% static "moment/moment-with-locales.js"      %}"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/noUiSlider/6.2.0/jquery.nouislider.min.js"></script>
<script src="{% static "DataTables/datatables.min.js" %}"   type="text/javascript" ></script>
<script src="{% static "mapsPicker/jquery-gmaps-latlon-picker.js" %}" ></script>
<script src="{% static "archivo/bootstrap-filestyle.min.js" %}"></script>
<script src="{% static "mustache/mustache.min.js" %}"   type="text/javascript" ></script>
<script src="{% static "select/js/bootstrap-select.min.js" %}"></script>
<script src="{% static "validatorNuevo/validator.js" %}"></script>
<script src="{% static "datetimepicker/js/bootstrap-datetimepicker.min.js"      %}"></script>
<!--<script src="{% static "socketio/socket.io.js" %}"></script>-->

{% verbatim %}
<script id="templatePuntosControl" type="x-tmpl-mustache">
<tr class="filaPuntoControl" style="margin: 1em; padding-bottom: 1em;"><td>

  <label >{{titulo}}</label><br/>
  <input type="hidden" class="titulo"  value="{{titulo}}"/></div>
  <input type="hidden" class="latitud"  value="{{latitud}}"/></div>
  <input type="hidden" class="longitud"  value="{{longitud}}"/></div>
  <!-- <span class="filaDireccion" style="display: none;">{{id}}</span><br/> -->
 
  <div class="row">
  	<div class="col-md-4">
		<div class="form-group estiloFormGroup" style="padding-bottom:1em;">
   				<!-- <label>Fecha Inicio:</label> -->
                <div class="input-group date formRangoFechaPunto" id="formRangoFechaPunto">
                  	<input id="inputFechaPunto" type="text" required class="form-control" data-date-format="DD/MM/YYYY" data-error="Ingrese una fecha (DD/MM/YYYY)" pattern="^[0-9][0-9]/[0-9][0-9]/[0-9][0-9][0-9][0-9]$">
                  	<span class="input-group-addon"><span class="glyphicon-calendar glyphicon"></span>
                  	</span>
        		</div>
        		<div class="help-block with-errors"></div>
         </div>
  	</div>
  	<div class="col-md-4">
		<div class="form-group estiloFormGroup">
			<!-- <label>Fecha Inicio:</label> -->
            <div class="input-group date formRangoHoraPunto" id="formRangoHoraPunto">
              	<input id="inputHoraPunto" type="text" required class="form-control" data-date-format="hh:mm a" data-error="Ingrese una hora (hh:mm)" pattern="^[0-9]?[0-9]:[0-9][0-9]\s[(a|A|p|P)][(m|M)]$">
              	<span class="input-group-addon"><span class="glyphicon-time glyphicon"></span>
              	</span>
    		</div>
    		<div class="help-block with-errors"></div>
         </div>
  	</div>
  	<div class="col-md-2" style="padding-right: 0;">
  		<div class="form-group estiloFormGroup">
	  		<span>
				<i class="fa fa-plus"></i></br>
				<i class="fa fa-minus"></i>
			</span>
			    <input id="formMinutos" name="formMinutos" type="text" class="form-control formMinutos"  style="margin-top: -2.5em;padding-left: 1.4em;">
			
		</div>
  	</div>
  	<div class="col-md-2"  style="padding-left: 0;">
  		<div class="form-group estiloFormGroup">
	  			<label style="margin-top: 1em;">minutos</label>
		</div>
  	</div>
  </div>
  
   <div style="text-align:right;"><input type="hidden" class="id"  value="{{id}}"/></div>

</td></tr>
</script>
{% endverbatim %}

<script>



 var conductores;
 var vehiculos;
 var rutas;

 //------ Cargar Tabla listado de rutas----------------------------------------------------
 function cargarTablaRutas(){
   	 
	 var peticion    = { 'autenticacion': {  'usuario' : config.getUsuarioLogin(),
                                             'token'   : config.getToken(),
                                             'tenant'  : config.getTennant(),
                                             
     },
                         'data'         : {                     					
                         }
     };

	// valida si la peticion es de un generador de carga
    if(config.getEsGeneradorCarga()){
		//si la peticion es de un generador de carga entonces a la autenticación se le agrega el codigo de acceso
    	peticion["autenticacion"]["codigoAcceso"] = config.getCodigoAcceso();
    }
	 
     var request = $.ajax({
         type: "POST",
         url		: "{% url 'wsListarAsignacionesRutas' %}",
         data	: {
             request: JSON.stringify(peticion)
         },
         dataType: "json"
     });
     request.done(function(respuesta){
         if(respuesta.success){
             pintarTablaRutas(respuesta["data"]);
         }else{ }
     });
     request.fail(function(jqXHR, textStatus){ });
 };


 function pintarTablaRutas(data){
	 var dataSet = data;

	 if ( ! $.fn.DataTable.isDataTable( '#graficoTabla' ) ) {
	     $('#graficoTabla').DataTable({
	         responsive: true,
	         data: dataSet,
	         fixedHeader:true,
			 
	         "pageLength"	:100,
	         "aaSorting": [],
	         language: traduccionDatatables,
	         columns: [
	             {  title: "Ruta Asignada",
					data : null
	             },
	             {  title: "Vehículo",
					data : null
	             },
	             {  title: "Fecha Inicio",
					data : null
	             },
	             {  title: "Fecha Fin",
					data : null
	             },
	             {  title: "Origen",
					data : null
	             },
	             {  title: "Destino",
					data : null
	             },
	             {  title: "Estado",
					data : null
	           	 },
	             {  title: "Acción",
					data : null
	             }
	             
	         ],
	         "columnDefs": [
	        	 { responsivePriority: 1, targets: 0 },
	        	 { responsivePriority: 2, targets: 1 },
				 
	      	     {
	      	         "targets": [0],
					 "render": function (data, type, full, meta){
					     var nombreRuta = "";
					     if( data.ruta != "" && data.ruta != null && data.id != ""){
							 nombreRuta = data.ruta.nombreRuta;
			    		 }
	                     return '<a href="'+guibase+'/{{tenant}}/adminDetalleAsignacionRuta/'+data.id+'/'+data.idRuta+'" >'+nombreRuta+'</a>';
	                 }

		    	 },
		    	 {
	      	         "targets": [1],
					 "render": function (data, type, full, meta){
						 var vehiculo = "";
						 var conductor = "";
					     if(data.vehiculo.placa!=""){
							 vehiculo = data.vehiculo.placa;
			    		 }
			    		 if(data.conductor.nombres!=""){
							 conductor = data.conductor.nombres+" "+data.conductor.apellidos;
			    		 }
			    		 
			    		 return '<div style="color:#eb2626"><a href="'+guibase+'/{{tenant}}/adminDetalleVehiculo/'+data.idVehiculo+'" >'+vehiculo+'</a></div> <hr style="margin: 0.2em;"/><div"> '+conductor+'</div>';
	                 }

		    	 },
		    	 {
	      	         "targets": [2],
					 "render": function (data, type, full, meta){
						 var vehiculo = "";
						 var fechaInicioProg = "";
						 var fechaReal = "";
					     if(data.fechaInicioProgramada!=""){
							 fechaInicioProg = moment(data.fechaInicioProgramada).format("DD/MM/YYYY, hh:mm a");
							 
							 if(data.fechaInicioReal!=""){
								 fechaReal = moment(data.fechaInicioReal).format("DD/MM/YYYY, hh:mm a");
								 
							 }
							 else{
								 console.log(data.estado);
								 if (data.estado== "programada"){
									 fechaReal = "Sin ejecución";
								 }
								 else if (data.estado== "iniciada"){
									 fechaReal = "En curso";
								 }
								 else if (data.estado== "finalizada"){
									 fechaReal = "Finalizada";
								 }
								 else if (data.estado== "noejecutada"){
									 fechaReal = "No ejecutada";
								 }
								 else if (data.estado== "abortada"){
									 fechaReal = "No ejecutada";
								 }
							 }
			    		 }
			    		 return '<div style="color:#777; font-weight: 600;">Prog.</div><div style="font-weight: 600;">'+fechaInicioProg+'</div> <hr style="margin: 0.2em;"/> <div style="color:#777; font-weight: 600;">Real.</div><div style="font-weight: 600;"> '+fechaReal+'</div>';
  						 
			    		 
	                 }

		    	 },
		    	 
		    	 {
	      	         "targets": [3],
					 "render": function (data, type, full, meta){
						 var vehiculo = "";
						 var fechaFinProg = "";
						 var fechaReal = "";
					     if(data.fechaFinProgramada!=""){
							 fechaFinProg = moment(data.fechaFinProgramada).format("DD/MM/YYYY, hh:mm a");
							 
							 if(data.fechaFinReal!=""){
								 fechaReal = moment(data.fechaFinReal).format("DD/MM/YYYY, hh:mm a");
							 }
							 else{
								 if (data.estado== "programada"){
									 fechaReal = "Sin ejecución";
								 }
								 else if (data.estado== "iniciada"){
									 fechaReal = "En curso";
								 }
								 else if (data.estado== "finalizada"){
									 fechaReal = "Finalizada";
								 }
								 else if (data.estado== "noejecutada"){
									 fechaReal = "No ejecutada";
								 }
								 else if (data.estado== "abortada"){
									 fechaReal = "No ejecutada";
								 }
							 }
			    		 }
			    		 return '<div style="color:#777; font-weight: 600;">Prog.</div><div style="font-weight: 600;">'+fechaFinProg+'</div> <hr style="margin: 0.2em;"/> <div style="color:#777; font-weight: 600;">Real.</div><div style="font-weight: 600;"> '+fechaReal+'</div>';
  						 
			    		 
	                 }

		    	 },
		    	 {
	      	         "targets": [4],
					 "render": function (data, type, full, meta){
						 var origen = "";
						 
					     if(data.ruta.origen.direccion!=""){
							 origen = data.ruta.origen.direccion;
							 
			    		 }
			    		 return origen;
  						 
			    		 
	                 }

		    	 },
		    	 {
	      	         "targets": [5],
					 "render": function (data, type, full, meta){
						 var destino = "";
						 
					     if(data.ruta.destino.direccion!=""){
							 destino = data.ruta.destino.direccion;
							 
			    		 }
			    		 return destino;
  						 
			    		 
	                 }

		    	 },
		    	 
	      	     {
	      	         "targets": [6],
					 "render": function (data, type, full, meta){
						 var estado = "";
					   	 if (data.estado== "programada"){
							 estado = "Programada";
						 }
						 else if (data.estado== "iniciada"){
							 estado = "Iniciada";
						 }
						 else if (data.estado== "finalizada"){
							 estado = "Finalizada";
						 }
						 else if (data.estado== "noejecutada"){
							 estado = "No ejecutada";
						 }
						 else if (data.estado== "abortada"){
							 estado = "Abortada";
						 }
			    		 return estado;
	                 }

		    	 },
	      	     {
	      	         "targets": [7],
					 "render": function (data, type, full, meta){
					     if(data.estado== "iniciada"){
							 return '<div style="text-align:center;"><input type="hidden" class="idRuta"  value="'+data.id+'"/><a class="abortarAsignacion" href="#" ><i class="fa fa-times-circle-o"></i> Abortar</a> </div>';	
			    		 }
					     else if(data.estado== "programada" || data.estado== "noejecutada"){
							 return '<div style="text-align:center;"><input type="hidden" class="idRuta"  value="'+data.id+'"/><a class="eliminarAsignacion" href="#" ><i class="fa fa-times-circle-o"></i> Eliminar</a> </div>';	
			    		 }
			    		 
			    		 return "";
	                 }

		    	 }		    	

	         ]
	     });
	 }   
	 else{
		 $('#graficoTabla').DataTable().clear().rows.add(dataSet).draw();
		 
	 }
 }


 function enviarEliminarAsignacion(idAsignacion){
	
	 var peticion    = { 'autenticacion': {  'usuario' : config.getUsuarioLogin(),
                                             'token'   : config.getToken(),
                                             'tenant'  : config.getTennant(),
     },
                         'data'         : {  
                        	 'idAsignacionRuta' : idAsignacion,
                         }
     };
	 
     var request = $.ajax({
         type: "POST",
         url		: "{% url 'wsEliminarAsignacionRuta' %}",
         data	: {
             request: JSON.stringify(peticion)
         },
         dataType: "json"
     });
     request.done(function(respuesta){
         if(respuesta.success){
        	 $('#formularioAceptarEliminarAsignacion').modal('hide');
             notif({
                 msg     : "La asignación de ruta se eliminó exitosamente",
                 type    : "success",
                 position: "center"
             });
             cargarTablaRutas();    
         }else{
        	 notif({
                 msg     : "Error al eliminar",
                 type    : "error",
                 position: "center"
             });
         }
     });
     request.fail(function(jqXHR, textStatus){ });
 }
 
 function enviarAbortarAsignacion(idAsignacion){
	
	 var peticion    = { 'autenticacion': {  'usuario' : config.getUsuarioLogin(),
                                             'token'   : config.getToken(),
                                             'tenant'  : config.getTennant(),
     },
                         'data'         : {  
                        	 'idAsignacionRuta' : idAsignacion,
                         }
     };
	 
     var request = $.ajax({
         type: "POST",
         url		: "{% url 'wsAbortarAsignacionRuta' %}",
         data	: {
             request: JSON.stringify(peticion)
         },
         dataType: "json"
     });
     request.done(function(respuesta){
         if(respuesta.success){
        	 $('#formularioAceptarAbortarAsignacion').modal('hide');
             notif({
                 msg     : "La asignación de ruta se aborto exitosamente",
                 type    : "success",
                 position: "center"
             });
             cargarTablaRutas();    
         }else{
        	 notif({
                 msg     : "Error al eliminar",
                 type    : "error",
                 position: "center"
             });
         }
     });
     request.fail(function(jqXHR, textStatus){ });
 }


 //------ Cargar picker de conductores----------------------------------------------------
 function traerConductores(){
     var peticion    = { 'autenticacion': {  'usuario' : config.getUsuarioLogin(),
                                             'token'   : config.getToken(),
                                             'tenant'  : config.getTennant(),          
     },
                         'data'          : {      }
     };
	 
     var request = $.ajax({
		 type        : "POST",
		 url         : "{% url 'wsPickerConductores' %}",
		 data        : {
             request :  JSON.stringify(peticion)
         },
		 dataType    : "json"

     }).done(function(respuesta){
         if (respuesta.success){

             cargarPickerConductores(respuesta.data);
         }
         else{
             notif({
                 msg     : respuesta.mensaje,
                 type    : "error",
                 position: "center"
             });
         }
     }).fail(function(jqXHR, textStatus){
         notif({
             msg     : "Falló la conexión",
             type    : "error",
             position: "center"
         });
     }).always(function(){
         
     });
 }

 function cargarPickerConductores(data){
     conductores   = data;
     var totalDatos	= conductores.length;
     for (i = 0; i < totalDatos; i++){
		 var itemconductor = conductores[i];
		 $('#grupoConductores').append('<option value="'+itemconductor.id+'">'+itemconductor.nombres+' '+itemconductor.apellidos+'</option>');
     }
     
     $('#grupoConductores').selectpicker('refresh');
	 $('#grupoConductores').selectpicker('deselectAll');
 	 $('#grupoConductores').selectpicker('refresh');
 }

 //------ Cargar picker de vehiculos----------------------------------------------------
 function traerVehiculos(){
     var peticion    = { 'autenticacion': {  'usuario' : config.getUsuarioLogin(),
                                             'token'   : config.getToken(),
                                             'tenant'  : config.getTennant(),          
     },
                         'data'          : {  
							 "numeroOpcionHabilitadaPlataforma" : "3" //Rutas
						     }
     };
      

	// valida si la peticion es de un generador de carga
    if(config.getEsGeneradorCarga()){
		//si la peticion es de un generador de carga entonces a la autenticación se le agrega el codigo de acceso
    	peticion["autenticacion"]["codigoAcceso"] = config.getCodigoAcceso();
    }   
	 
     var request = $.ajax({
		 type        : "POST",
		 url         : "{% url 'wsPickerVehiculos' %}",
		 data        : {
             request :  JSON.stringify(peticion)
         },
		 dataType    : "json"

     }).done(function(respuesta){
         if (respuesta.success){

             cargarPickerVehiculos(respuesta.data);
         }
         else{
             notif({
                 msg     : respuesta.mensaje,
                 type    : "error",
                 position: "center"
             });
         }
     }).fail(function(jqXHR, textStatus){
         notif({
             msg     : "Falló la conexión",
             type    : "error",
             position: "center"
         });
     }).always(function(){
         
     });
 }

 function cargarPickerVehiculos(data){
     vehiculos   = data;
     var totalDatos	= vehiculos.length;
     for (i = 0; i < totalDatos; i++){
		var itemvehiculo = vehiculos[i];
		$('#grupoVehiculos').append('<option value="'+itemvehiculo.id+'">'+itemvehiculo.vehiculo.placa+'</option>');

     }
     $('#grupoVehiculos').selectpicker('refresh');
	 $('#grupoVehiculos').selectpicker('deselectAll');
 	 $('#grupoVehiculos').selectpicker('refresh');
 }

 //------ Cargar picker de rutas----------------------------------------------------
 function traerRutas(){
     var peticion    = { 'autenticacion': {  'usuario' : config.getUsuarioLogin(),
                                             'token'   : config.getToken(),
                                             'tenant'  : config.getTennant(),          
     },
                         'data'          : {      }
     };
	 
     var request = $.ajax({
		 type        : "POST",
		 url         : "{% url 'wsPickerRutas' %}",
		 data        : {
             request :  JSON.stringify(peticion)
         },
		 dataType    : "json"

     }).done(function(respuesta){
         if (respuesta.success){

             cargarPickerRutas(respuesta.data);
         }
         else{
             notif({
                 msg     : respuesta.mensaje,
                 type    : "error",
                 position: "center"
             });
         }
     }).fail(function(jqXHR, textStatus){
         notif({
             msg     : "Falló la conexión",
             type    : "error",
             position: "center"
         });
     }).always(function(){
         
     });
 }

 function cargarPickerRutas(data){
     rutas   = data;
     var totalDatos	= rutas.length;
     for (i = 0; i < totalDatos; i++){
		 var itemruta = rutas[i];
		 $('#grupoRutas').append('<option value="'+itemruta.id+'">'+itemruta.nombre+'</option>');
     }
     
     $('#grupoRutas').selectpicker('refresh');
	 $('#grupoRutas').selectpicker('deselectAll');
 	 $('#grupoRutas').selectpicker('refresh');
 	 
 	 var idRuta 	= $('#grupoRutas').val();
	 traerPuntosControlRuta(idRuta);
 }


 //------ Cargar listado puntos de control----------------------------------------------------
 function traerPuntosControlRuta(idRuta){
     var peticion    = { 'autenticacion': {  'usuario' : config.getUsuarioLogin(),
                                             'token'   : config.getToken(),
                                             'tenant'  : config.getTennant(),          
     },
                         'data'          : {  
                        	 "id":idRuta,    
                         }
     };
	 
     var request = $.ajax({
		 type        : "POST",
		 url         : "{% url 'wsDetallePuntoControlRuta' %}",
		 data        : {
             request :  JSON.stringify(peticion)
         },
		 dataType    : "json"

     }).done(function(respuesta){
         if (respuesta.success){

             cargarListadoPuntosControl(respuesta.data);
         }
         else{
             notif({
                 msg     : respuesta.mensaje,
                 type    : "error",
                 position: "center"
             });
         }
     }).fail(function(jqXHR, textStatus){
         notif({
             msg     : "Falló la conexión",
             type    : "error",
             position: "center"
         });
     }).always(function(){
         
     });
 }

 function cargarListadoPuntosControl(data){
     puntosControl   = data.puntosControl;
     var totalDatos	= puntosControl.length;
     var numPunto	= 0;
     var fechaAhora 	= moment();
     var horaaActual = moment().format('HH:mm');
     
     $("#menuContenedorPuntosDeControl").empty();
     
     if(totalDatos>0){
    	 $( "#textoSinPuntosControl").hide();
	     for (i = 0; i < totalDatos; i++){
			 var itempuntoControl = puntosControl[i];
			 numPunto 	+= 1;
		  	 var template 		 = $('#templatePuntosControl').html();
	         Mustache.parse(template);
	         var html = Mustache.render(template,
	        							{
	        	 							
	        	 							latitud   : itempuntoControl[0],
	        	 							longitud  : itempuntoControl[1],
	        	 							titulo    : numPunto+". "+itempuntoControl[2],
	        							});
	         $('#menuContenedorPuntosDeControl').append(html);
			 
	     }
		 
	     
		 $( ".formRangoFechaPunto" ).each(function( index, element ) {
			 var elemento 			= $(element);
			 elemento.datetimepicker(
		         { 
		        	 pickTime: false,
		          	 showToday: true,
		          	 pick12HourFormat: true,
		          	 minViewMode: "years",
					 minViewMode: "months",
					 minViewMode: "days",
					 minDate: moment(),
					 language:'es' 
					 
				 });
			 elemento	.data('DateTimePicker').setDate(fechaAhora);
			 
		 });
		 
		 
		 $( ".formRangoHoraPunto" ).each(function( index, element ) {
		     var elemento 			= $(element);
		     elemento.datetimepicker(
		         { 
		        	 pickTime: true,
		        	 pickDate: false,
		          	 showToday: true,
		          	 pick12HourFormat: true,
		          	 minViewMode: "years",
					 minViewMode: "months",
					 minViewMode: "days",
					 minDate: moment(),
					 language:'es' 
				 });
			 elemento.data('DateTimePicker').setDate(horaaActual);   
		 });
	 }
	 else{
   		 $( "#textoSinPuntosControl").show();
	 }
 }



 //------ Enviar datos de creacion de asignacion de rutas----------------------------------------------------
 function enviarAignacionRuta(){
	 var idRuta					= $('#grupoRutas').val();
	 var vehiculo				= $('#grupoVehiculos').val();
	 var conductor				= $('#grupoConductores').val();
	 var fechaInicioProgramada	= $('#formRangoFecha1').data('DateTimePicker').date.format();
	 var fechaFinProgramada		= $('#formRangoFecha2').data('DateTimePicker').date.format();
	 var listadoPuntosControl 	= [];
	 
	 $( "tr.filaPuntoControl" ).each(function( index, element ) {
	     var elemento 					= $(element);
	     var latitud						= elemento.find('.latitud').val();
	     var longitud					= elemento.find('.longitud').val();
	     var direccion					= elemento.find('.titulo').val();
	     var fechaCruceReal				= "";
	     var fechaCruceProgramada		= elemento.find('.formRangoFechaPunto').data('DateTimePicker').date.format("YYYY-MM-DD");
		 var HoraCruceProgramada			= elemento.find('.formRangoHoraPunto').data('DateTimePicker').date.format("HH:mm:ss");	
		 var minutosTolerancia			= elemento.find('.formMinutos').val();
		 
		 var puntoControl				= {
			 "latitud"   : latitud,
			 "longitud"  : longitud,
			 "direccion" : direccion,
			 "fechaHoraCruceReal"       : fechaCruceReal,
			 "fechaHoraCruceProgramada" : fechaCruceProgramada+"T"+HoraCruceProgramada,
			 "minutosTolerancia"        : minutosTolerancia
			 
		 };
		 listadoPuntosControl.push(puntoControl);									
 	 });

	 
     var peticion    = { 'autenticacion': {  'usuario' : config.getUsuarioLogin(),
                                             'token'   : config.getToken(),
                                             'tenant'  : config.getTennant(),          
     },
                         'data'          : {  
                        	 "idRuta"                 : idRuta,
							 "idVehiculo"             : vehiculo,
							 "idConductor"            : conductor,
							 "fechaInicioProgramada"  : fechaInicioProgramada,
							 "fechaFinProgramada"     : fechaFinProgramada,
							 "puntosDeControlVirtual" : listadoPuntosControl
							 
                         }
     };
	 
     var request = $.ajax({
		 type        : "POST",
		 url         : "{% url 'wsCrearAsignacionRuta' %}",
		 data        : {
             request :  JSON.stringify(peticion)
         },
		 dataType    : "json"

     }).done(function(respuesta){
         if (respuesta.success){
			 notif({
                 msg     : "Se creo exitosamente la asignacion de ruta",
                 type    : "success",
                 position: "center"
             });
			 setTimeout(function() { location.reload(true);}, 3000);
         }
         else{
             notif({
                 msg     : respuesta.mensaje,
                 type    : "error",
                 position: "center"
             });
         }
     }).fail(function(jqXHR, textStatus){
         notif({
             msg     : "Falló la conexión",
             type    : "error",
             position: "center"
         });
     }).always(function(){
         
     });
 }


 // === Document ready!!! =======================================================
 var socket = null;
 $(document).ready(function() {
 	var fechaAhora = moment();	
	// valida si la peticion es de un generador de carga
    if(config.getEsGeneradorCarga()){
		//si la peticion es de un generador de carga entonces muestra el mensaje del rango de fechas definidos por el codigo de acceso
		var fechaDesde = fechaAhora.format("DD/MM/YYYY h:mm a");
		var fechaHasta = moment(config.getFechaCaducidad()).format("DD/MM/YYYY h:mm a");
    	$("#textoInfoFechas").text('Habilitado desde '+fechaDesde+ ' hasta '+ fechaHasta);
    }
	 
	 traerVehiculos();
	 traerRutas();
	 cargarTablaRutas();
	 traerConductores();
	 
	 
	 //var fechaAhora = moment();
	 var fechaManana = moment().add(1, 'days');
	 $('.formRangoFecha').datetimepicker(

	     { 
	         pickTime: true,
	         showToday: true,
	         pick12HourFormat: true,
	         minViewMode: "years",
			 minViewMode: "months",
			 minViewMode: "days",
			 minDate: moment(),
			 language:'es' });
	 
	 
	 $('#formRangoFecha1').data('DateTimePicker').setDate(fechaAhora);
	 $('#formRangoFecha2').data('DateTimePicker').setDate(fechaManana);
	 
	 //Valida la fecha y hora inicio programada
	 $("#formRangoFecha1").on("dp.change", function(e) {
		 var fecha = e.date;
		 var hora = $('#formRangoFecha1').data('DateTimePicker').date.format('HH:mm');
		 var fechaActual = moment();
		 var horaaActual = moment().format('HH:mm');
		 if(fecha < fechaActual){
			 if (hora < horaaActual){
				 notif({
	                 msg     : "Debes seleccionar una hora mayor a la actual",
	                 type    : "warning",
	                 position: "center"
            	 });
			 }
			 else{
				 notif({
	                 msg     : "Debes seleccionar una fecha mayor a la actual",
	                 type    : "warning",
	                 position: "center"
	             });
			 }
			 
		 }
		 else if(fecha == fechaActual){
			 if (hora < horaaActual){
				 notif({
	                 msg     : "Debes seleccionar una hora mayor a la actual",
	                 type    : "warning",
	                 position: "center"
            	 });
			 }
		 }  
		 
		 
	 });
	 
	 
	 //Valida la fecha y hora fin programada
	 $("#formRangoFecha2").on("dp.change", function(e) {
		 var fecha = e.date;
		 var hora = $('#formRangoFecha2').data('DateTimePicker').date.format('HH:mm');
		 var fechaActual = moment();
		 var horaaActual = moment().format('HH:mm');
		 if(fecha < fechaActual){
			 if (hora < horaaActual){
				 notif({
	                 msg     : "Debes seleccionar una hora mayor a la actual",
	                 type    : "warning",
	                 position: "center"
            	 });
			 }
			 else{
				 notif({
	                 msg     : "Debes seleccionar una fecha mayor a la actual",
	                 type    : "warning",
	                 position: "center"
	             });
			 }
			 
		 }
		 else if(fecha == fechaActual){
			 if (hora < horaaActual){
				 notif({
	                 msg     : "Debes seleccionar una hora mayor a la actual",
	                 type    : "warning",
	                 position: "center"
            	 });
			 }
		 }  
		 
		 
	 });
	 
	 //Valida la  fecha de cruce programada
	 $(document).on("dp.change", ".formRangoFechaPunto", function(element) {
		 var elemento 	= $(element);
		 var fecha 		= element.date.format('DD/MM/YYYY');
		 var fechaActual = moment();
		 var horaaActual = moment().format('HH:mm');
		 
		 if (fecha < fechaActual){
			 notif({
	             msg     : "Debes seleccionar una fecha mayor a la actual",
	             type    : "warning",
	             position: "center"
             });
		 }
		 
	 });
	 
	 //Valida la  hora cruce programada
	 $(document).on("dp.change", ".formRangoHoraPunto", function(element) {
		 var elemento 			= $(this);

		 var hora				= element.date.format('HH:mm');
		 var fecha 				= elemento.closest('.filaPuntoControl').find(".formRangoFechaPunto").data('DateTimePicker').date.format();
		 var fechaActual 		= moment().format();
		 var horaaActual 		= moment().format('HH:mm');
		 
		 if (hora < horaaActual){
			 if(fecha <fechaActual){
				 notif({
		             msg     : "Debes seleccionar una hora mayor a la actual",
		             type    : "warning",
		             position: "center"
	             });
			 }
			 
		 }
		 
	 });
	 
	 
	 
	 $('#grupoRutas').on('change', function(){
		 var selected = $('.selectpicker option:selected').val();
		 var idRuta 	= $('#grupoRutas').val();
		 traerPuntosControlRuta(idRuta);
	 });

	 
     $(document).on('click', '#crearRuta', function(){
         window.location.href = "{% url 'adminCrearRuta' tenant=tenant %}";
     });

	 //=============eliminar asignacion ruta
	 $(document).on('click', '.eliminarAsignacion', function(){
		 var idAsignacion 	= $(this).parent().find('.idRuta').val();
		 $('#formRutaIdAsignacion')   	.val(idAsignacion);
		 $('#formularioAceptarEliminarAsignacion').modal('show');
	 });

	 $(document).on('click', '#aceptarEliminarAsignacion', function(){
		 var idAsignacion = $('#formRutaIdAsignacion').val();
		 enviarEliminarAsignacion(idAsignacion);
	 });
	 
	  //=============abortar asignacion ruta
	 $(document).on('click', '.abortarAsignacion', function(){
		 var idAsignacion 				= $(this).parent().find('.idRuta').val();
		 $('#formRutaIdAsignacion')   	.val(idAsignacion);
		 $('#formularioAceptarAbortarAsignacion').modal('show');
	 });

	 $(document).on('click', '#aceptarAbortarAsignacion', function(){
		 var idAsignacion = $('#formRutaIdAsignacion').val();
		 enviarAbortarAsignacion(idAsignacion);
	 });
	 
	 //Validador
	 
	 $('#formularioCrearAsignacion').validator().on('submit', function (e) {
		 if (e.isDefaultPrevented()) {
			 notif({
                 msg     : "Invalido campo",
                 type    : "error",
                 position: "center"
             });
		 } else {
			 var permitirEnvioRuta		= validarFechasUsuario('#formRangoFecha1', '#formRangoFecha2');
			 var algo					= "";
		  	 // --------------valida si la peticion es de un generador de carga------------------
		  	var permiteAccionGeneradorCarga = {success: true, tipoFecha: ""}; 	
		    if(config.getEsGeneradorCarga()){
				//si la peticion es de un generador de carga se validan las fechas con las configuradas por un cliente
				var fechaGeneracion = moment(config.getFechaGeneracion());
				var fechaCaducidad  = moment(config.getFechaCaducidad());
				permiteAccionGeneradorCarga = validarFechasGeneradorCarga("#formRangoFecha1", "#formRangoFecha2", "DD/MM/YYYY h:mm a");
				if(permiteAccionGeneradorCarga["tipoFecha"] == "fechaGeneracion"){
					//se le asigna la fecha inicial la fecha de generacion
					$('#formRangoFecha1').data('DateTimePicker').setDate(fechaGeneracion);
					permiteAccionGeneradorCarga["success"] = true;	
				}else if(permiteAccionGeneradorCarga["tipoFecha"] == "fechaCaducidad"){
					//se le asigna la fecha fin la fecha de caducidad
					$('#formRangoFecha2').data('DateTimePicker').setDate(fechaCaducidad);
					permiteAccionGeneradorCarga["success"] = true;
				}
		    }
			 if(permitirEnvioRuta && permiteAccionGeneradorCarga["success"]){
			 	enviarAignacionRuta();
	   		 }
			 e.preventDefault();
		 }
     });	

 });
 // --- End document ready ------------------------------------------------------



</script>
{% endblock %}

{% block contenido %}
<body>
	<div id="page-wrapper" style="  margin: 3em; margin-top: 0;">
	
	    <div class="row">
	        <div class="col-lg-12">
	            <h2 class="rojoFleet">Asignación ruta <span id="textoNombre"></span><small> Registro nueva asignación </small><small class="rojoFleet" id="textoInfoFechas"></small></h2>
	        </div>
	        <!-- /.col-lg-12 -->
	    </div>
	    <!-- /.row -->
	    <div class="row">
	        <div class="col-lg-12">
	            <div class="panel panel-default">
	                
	                <!-- /.panel-heading -->

	                <div class="panel-body">
						<form data-toggle="validator" role="form" id="formularioCrearAsignacion">
							<div class="row">
								<div class="col-md-3">
									<div class="form-group">
					           				<label>Fecha Inicio:</label>
							                <div class="input-group date formRangoFecha" id="formRangoFecha1">
							                  	<input id="inputPeriodoGrafico1" type="text" required="" class="form-control" data-date-format="DD/MM/YYYY hh:mm a" data-error="Ingrese una fecha (DD/MM/YYYY hh:mm)" pattern="^[0-9][0-9]/[0-9][0-9]/[0-9][0-9][0-9][0-9]\s[0-9]?[0-9]:[0-9][0-9]\s[(a|A|p|P)][(m|M)]$">
							                  	<span class="input-group-addon"><span class="glyphicon-calendar glyphicon"></span>
							                  	</span>
						            		</div>
						            		<div class="help-block with-errors"></div>
							         </div>
									<div class="form-group">
									    <label  for="grupoVehiculos">Vehículo</label><label> </label>
									    <div id="selectConductores">
									      <select class="selectpicker" data-width="fit"  data-live-search="true" title="Seleccionar vehículo" id="grupoVehiculos" name="grupoVehiculos">
								
									      </select>
									    </div>
									</div>
									<div class="form-group">
									    <label  for="grupoConductores">Conductor</label><label> </label>
									    <div id="selectConductores">
									      <select class="selectpicker" data-width="fit"  data-live-search="true" title="Seleccionar conductor" id="grupoConductores" name="grupoConductores">
										
									      </select>
									    </div>
									</div>
								
								</div>
								<div class="col-md-3">
									<div class="form-group">
					           				<label>Fecha Fin:</label>
							                <div class="input-group date formRangoFecha" id="formRangoFecha2">
							                  	<input id="inputPeriodoGrafico2" type="text" required="" class="form-control" data-date-format="DD/MM/YYYY hh:mm a" data-error="Ingrese una fecha (DD/MM/YYYY hh:mm)" pattern="^[0-9][0-9]/[0-9][0-9]/[0-9][0-9][0-9][0-9]\s[0-9]?[0-9]:[0-9][0-9]\s[(a|A|p|P)][(m|M)]$">
							                  	<span class="input-group-addon"><span class="glyphicon-calendar glyphicon"></span>
							                  	</span>
						            		</div>
						            		<div class="help-block with-errors"></div>
							         </div>
									<div class="form-group">
									    <label  for="grupoRutas">Asignar ruta</label><label> </label>
									    <div id="selectRutas">
									      <select class="selectpicker" data-width="fit"  data-live-search="true" title="Seleccionar ruta" id="grupoRutas" name="grupoRutas">
										
									      </select>
									    </div>
									</div>
									
								</div>
								
								<div class="col-md-6">
									<label style="color: #eb2626;">Puntos de control</label>
									<div class="" style="max-height: 100.65em; overflow:auto;">
										<div id="menuContenedorPuntosDeControl" style="padding: 1em;">
		      							</div>
		      							<label id="textoSinPuntosControl" style="display: none; color:#000000;">La ruta seleccionada no tiene puntos de control definidos.</label>
	      							</div>
								</div>
								
							</div>
					
							<button id="enviarAsignacion" type="submit" class="btn btn-raised btn-success enviarAsignacion positionBoton">
								Guardar Asignación
							</button>
						</form>
					</div>
	                <!-- /.panel-body -->
	            </div>
	            <!-- /.panel -->
	        </div>
	        <!-- /.col-lg-12 -->
	    </div>
	
	</div>
	
	
	
	
	
	<div id="page-wrapper" style="  margin: 3em; margin-top: 0;">
	
	    <div class="row">
	        <div class="col-lg-12">
	            <h1 class="">Listado de Rutas Asignadas</h1>
	        </div>
	        <!-- /.col-lg-12 -->
	    </div>
	    <!-- /.row -->
	    <div class="row">
	        <div class="col-lg-12">
	            <div class="panel panel-default">
	                <!-- /.panel-heading -->
	                <!-- <button id="crearZona" type="submit" class="btn btn-raised btn-lg btn-success btn-block "> -->
	             
	                <div class="panel-body">
	                	
	                	
	                	
	                	
	                	

						<div class="tabbable pestana">
						  <ul class="nav nav-tabs">						   	
						      <table id="graficoTabla" class="table table-striped table-bordered display" style="width: 100%">
		                      </table>
						</div>
					</div>
	                <!-- /.panel-body -->
	            </div>
	            <!-- /.panel -->
	        </div>
	        <!-- /.col-lg-12 -->
	    </div>
	</div>
<!-- /#page-wrapper -->

<!-- /#MODAL, VENTANA EMERGENTE PARA ACEPTAR ELIMINAR ASIGNACION RUTA-->
<div class="modal fade" id="formularioAceptarEliminarAsignacion" > 
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title">Eliminar asignación ruta</h3>
      </div>
      <div class="modal-body">
      	<form>
      	<div class="row">
			<div class="col-md-10">
				<input type="hidden" id="formRutaIdAsignacion"/>
				<span> ¿Está seguro de eliminar la asignación de ruta?</span>
			</div>
		</div>
        
		</form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-success" id="aceptarEliminarAsignacion">Eliminar asignación</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!-- /#MODAL, VENTANA EMERGENTE PARA ACEPTAR ELIMINAR ASIGNACION RUTA-->

<!-- /#MODAL, VENTANA EMERGENTE PARA ACEPTAR ABORTAR ASIGNACION RUTA-->
<div class="modal fade" id="formularioAceptarAbortarAsignacion" > 
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title">Abortar asignación ruta</h3>
      </div>
      <div class="modal-body">
      	<form>
      	<div class="row">
			<div class="col-md-10">
				<input type="hidden" id="formRutaIdAsignacion"/>
				<span> La ruta se encuentra en estado de ejecución. ¿Está seguro de abortar la asignación de ruta?</span>
			</div>
		</div>
        
		</form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-success" id="aceptarAbortarAsignacion">Abortar asignación</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
<!-- /#MODAL, VENTANA EMERGENTE PARA ACEPTAR ELIMINAR ASIGNACION RUTA-->


</body>

{% endblock %}
